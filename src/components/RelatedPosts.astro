---
import type { CollectionEntry } from "astro:content";
import { getRelatedPosts } from "@/utils/getRelatedPosts";
import { getPath } from "@/utils/getPath";
import { slugifyStr } from "@/utils/slugify";
import Datetime from "./Datetime.astro";
import Tag from "./Tag.astro";

export interface Props {
  currentPost: CollectionEntry<"blog">;
  allPosts: CollectionEntry<"blog">[];
  maxPosts?: number;
  showTags?: boolean;
}

const { currentPost, allPosts, maxPosts = 3, showTags = true } = Astro.props;

// Get related posts
const relatedPosts = getRelatedPosts(currentPost, allPosts, maxPosts);

// Only show the component if we have related posts
if (relatedPosts.length === 0) {
  return null;
}
---

<div class="mt-12 bg-gray-50 dark:bg-gray-900 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
  <h3 class="text-xl font-semibold mb-6 text-gray-900 dark:text-white">
    Related Posts
  </h3>
  
  <div class="space-y-6">
    {relatedPosts.map((relatedPost) => (
      <article class="group">
        <a 
          href={getPath(relatedPost.slug, `src/data/blog/${relatedPost.slug}.md`)}
          class="block hover:opacity-80 transition-opacity duration-200"
        >
          <h4 class="text-lg font-medium text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors duration-200 mb-2">
            {relatedPost.title}
          </h4>
          
          <p class="text-gray-600 dark:text-gray-300 text-sm mb-3 line-clamp-2">
            {relatedPost.description}
          </p>
          
          <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
            <Datetime 
              pubDatetime={relatedPost.pubDatetime}
              modDatetime={null}
              timezone={undefined}
              size="sm"
            />
            
            {showTags && relatedPost.tags.length > 0 && (
              <div class="flex flex-wrap gap-1">
                {relatedPost.tags.slice(0, 2).map(tag => (
                  <Tag 
                    tag={slugifyStr(tag)} 
                    tagName={tag}
                  />
                ))}
                {relatedPost.tags.length > 2 && (
                  <span class="text-gray-400">+{relatedPost.tags.length - 2}</span>
                )}
              </div>
            )}
          </div>
        </a>
      </article>
    ))}
  </div>
  
  <!-- Show more related posts link -->
  {relatedPosts.length === maxPosts && (
    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
      <a 
        href="/posts" 
        class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 font-medium"
      >
        View all posts â†’
      </a>
    </div>
  )}
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

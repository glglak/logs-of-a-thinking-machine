---
// Newsletter Popup Component using Buttondown (Free tier: 100 subscribers)
// Shows after user scrolls 50% of the page or after 30 seconds
// Only shows once per session (uses sessionStorage)
// SETUP: Replace 'logsofthinking' with your Buttondown username
const BUTTONDOWN_USERNAME = "logsofthinking";
---

<div id="newsletter-popup" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm p-4">
  <div class="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-8 transform transition-all">
    <!-- Close Button -->
    <button 
      id="close-popup"
      class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
      aria-label="Close popup"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <!-- Content -->
    <div class="text-center">
      <!-- Icon -->
      <div class="mx-auto w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mb-6 shadow-lg">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
        </svg>
      </div>

      <!-- Headline -->
      <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">
        Don't Miss AI Insights
      </h3>
      
      <!-- Subtext -->
      <p class="text-gray-600 dark:text-gray-300 mb-6">
        Join developers and tech leaders receiving curated AI updates. No spam, unsubscribe anytime.
      </p>

      <!-- Buttondown Form - Better deliverability -->
      <form
        action={`https://buttondown.email/api/emails/embed-subscribe/${BUTTONDOWN_USERNAME}`}
        method="post"
        target="popupwindow"
        class="space-y-4"
      >
        <input
          type="email"
          name="email"
          placeholder="Enter your email"
          required
          class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
        />
        <button
          type="submit"
          class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold rounded-lg transition-all shadow-lg hover:shadow-xl"
        >
          Subscribe for Free
        </button>
      </form>

      <!-- Trust Signals -->
      <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">
        Privacy-first • Weekly digest • AI-curated content
      </p>
    </div>
  </div>
</div>

<script>
  function initNewsletterPopup() {
    const popup = document.getElementById('newsletter-popup');
    const closeBtn = document.getElementById('close-popup');
    
    if (!popup || !closeBtn) return;
    
    // Check if already shown this session
    if (sessionStorage.getItem('newsletter-popup-shown')) return;
    
    const showPopup = () => {
      if (sessionStorage.getItem('newsletter-popup-shown')) return;
      popup.classList.remove('hidden');
      popup.classList.add('flex');
      sessionStorage.setItem('newsletter-popup-shown', 'true');
    };
    
    const hidePopup = () => {
      popup.classList.add('hidden');
      popup.classList.remove('flex');
    };
    
    // Close button
    closeBtn.addEventListener('click', hidePopup);
    
    // Click outside to close
    popup.addEventListener('click', (e) => {
      if (e.target === popup) hidePopup();
    });
    
    // Escape key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hidePopup();
    });
    
    // Show after 30 seconds OR 50% scroll, whichever comes first
    let hasTriggered = false;
    
    // Timer trigger
    setTimeout(() => {
      if (!hasTriggered) {
        hasTriggered = true;
        showPopup();
      }
    }, 30000);
    
    // Scroll trigger
    const handleScroll = () => {
      if (hasTriggered) return;
      
      const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
      if (scrollPercent > 50) {
        hasTriggered = true;
        showPopup();
        window.removeEventListener('scroll', handleScroll);
      }
    };
    
    window.addEventListener('scroll', handleScroll, { passive: true });
  }
  
  // Initialize on page load and after Astro transitions
  initNewsletterPopup();
  document.addEventListener('astro:after-swap', initNewsletterPopup);
</script>

